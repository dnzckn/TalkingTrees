<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyForest - Code View</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
        }

        .app {
            display: grid;
            grid-template-rows: 60px 1fr;
            height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, #2d2d30 0%, #252526 100%);
            border-bottom: 2px solid #0e639c;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .title {
            font-size: 18px;
            font-weight: 600;
            color: #0e639c;
        }

        .subtitle {
            font-size: 13px;
            color: #888;
            margin-left: 15px;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            background: #0e639c;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #1177bb;
        }

        .btn.secondary {
            background: #3e3e42;
        }

        .btn.secondary:hover {
            background: #4e4e52;
        }

        .btn.success {
            background: #16825d;
        }

        .btn.success:hover {
            background: #1a9870;
        }

        /* Main Content */
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0;
            height: 100%;
        }

        .panel {
            background: #1e1e1e;
            border-right: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
        }

        .panel:last-child {
            border-right: none;
        }

        .panel-header {
            background: #2d2d30;
            padding: 12px 15px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 14px;
            font-weight: 600;
            color: #0e639c;
        }

        .panel-badge {
            background: #0e639c;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .panel-badge.editable {
            background: #16825d;
        }

        .panel-content {
            flex: 1;
            overflow: auto;
            padding: 15px;
        }

        /* Tree View */
        .tree-view {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .tree-node {
            margin-left: 20px;
            margin-bottom: 8px;
        }

        .tree-node.root {
            margin-left: 0;
        }

        .node-line {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .node-icon {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .node-icon.sequence { background: #0e639c; }
        .node-icon.selector { background: #c586c0; }
        .node-icon.parallel { background: #4ec9b0; }
        .node-icon.condition { background: #dcdcaa; }
        .node-icon.action { background: #4fc1ff; }
        .node-icon.decorator { background: #ce9178; }

        .node-name {
            color: #dcdcaa;
            font-weight: 600;
        }

        .node-type {
            color: #888;
            font-size: 11px;
        }

        /* JSON Editor */
        #json-editor {
            width: 100%;
            height: calc(100% - 50px);
            background: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid #3e3e42;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 12px;
            resize: none;
            line-height: 1.6;
        }

        #json-editor:focus {
            outline: none;
            border-color: #0e639c;
        }

        .json-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        /* Python Code */
        #python-code {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.6;
            overflow-x: auto;
        }

        /* Syntax highlighting */
        .keyword { color: #c586c0; }
        .string { color: #ce9178; }
        .comment { color: #6a9955; }
        .function { color: #dcdcaa; }
        .number { color: #b5cea8; }
        .operator { color: #d4d4d4; }

        /* File Input */
        #file-input {
            display: none;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 70px;
            right: 20px;
            background: #16825d;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-size: 13px;
            animation: slideIn 0.3s ease;
            z-index: 1000;
        }

        .notification.error {
            background: #f14c4c;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #d4d4d4;
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <div style="display: flex; align-items: center;">
                <div class="title">PyForest Code View</div>
                <div class="subtitle">Visual ↔ JSON ↔ Python</div>
            </div>
            <div class="actions">
                <input type="file" id="file-input" accept=".json">
                <button class="btn secondary" onclick="document.getElementById('file-input').click()">
                    Load JSON File
                </button>
                <button class="btn" onclick="downloadJSON()">
                    Save JSON
                </button>
                <button class="btn success" onclick="copyPythonCode()">
                    Copy Python Code
                </button>
            </div>
        </div>

        <div class="content">
            <!-- Visual Tree Panel -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">Visual Tree</span>
                    <span class="panel-badge">Read-only</span>
                </div>
                <div class="panel-content">
                    <div id="tree-view" class="tree-view"></div>
                </div>
            </div>

            <!-- JSON Editor Panel -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">JSON TreeDefinition</span>
                    <span class="panel-badge editable">Editable</span>
                </div>
                <div class="panel-content">
                    <textarea id="json-editor" spellcheck="false"></textarea>
                    <div class="json-actions">
                        <button class="btn success" onclick="applyJSONChanges()">
                            Apply Changes
                        </button>
                        <button class="btn secondary" onclick="formatJSON()">
                            Format
                        </button>
                    </div>
                </div>
            </div>

            <!-- Python Code Panel -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">py_trees Python Code</span>
                    <span class="panel-badge">Read-only</span>
                </div>
                <div class="panel-content">
                    <pre id="python-code"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTree = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('file-input').addEventListener('change', loadFile);
            showEmptyState();
        });

        // Load file
        function loadFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const treeData = JSON.parse(e.target.result);
                    loadTree(treeData);
                    showNotification('Tree loaded successfully!', 'success');
                } catch (error) {
                    showNotification('Error loading file: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // Load tree from data
        function loadTree(treeData) {
            currentTree = treeData;

            // Update all panels
            updateVisualTree();
            updateJSONEditor();
            updatePythonCode();
        }

        // Update visual tree panel
        function updateVisualTree() {
            const container = document.getElementById('tree-view');
            container.innerHTML = '';

            if (!currentTree) {
                showEmptyState();
                return;
            }

            const html = `
                <div class="tree-node root">
                    <div style="margin-bottom: 15px;">
                        <div style="font-size: 16px; font-weight: 600; color: #0e639c; margin-bottom: 5px;">
                            ${currentTree.metadata.name}
                        </div>
                        <div style="font-size: 11px; color: #888;">
                            Version ${currentTree.metadata.version} • ${currentTree.metadata.description || 'No description'}
                        </div>
                    </div>
                    ${renderTreeNode(currentTree.root)}
                </div>
            `;

            container.innerHTML = html;
        }

        // Render tree node recursively
        function renderTreeNode(node, depth = 0) {
            const iconClass = getNodeIconClass(node.node_type);
            const icon = getNodeIcon(node.node_type);

            let html = `
                <div class="tree-node">
                    <div class="node-line">
                        <div class="node-icon ${iconClass}">${icon}</div>
                        <span class="node-name">${node.name}</span>
                        <span class="node-type">${node.node_type}</span>
                    </div>
            `;

            if (node.children && node.children.length > 0) {
                for (const child of node.children) {
                    html += renderTreeNode(child, depth + 1);
                }
            }

            html += '</div>';
            return html;
        }

        // Get node icon class
        function getNodeIconClass(nodeType) {
            if (nodeType === 'Sequence') return 'sequence';
            if (nodeType === 'Selector') return 'selector';
            if (nodeType === 'Parallel') return 'parallel';
            if (nodeType.includes('Check')) return 'condition';
            if (nodeType.includes('Set') || nodeType.includes('Log')) return 'action';
            if (nodeType.includes('Inverter') || nodeType.includes('Retry') || nodeType.includes('Repeat')) return 'decorator';
            return 'action';
        }

        // Get node icon
        function getNodeIcon(nodeType) {
            if (nodeType === 'Sequence') return '→';
            if (nodeType === 'Selector') return '?';
            if (nodeType === 'Parallel') return '⫴';
            if (nodeType.includes('Check')) return '✓';
            if (nodeType.includes('Set')) return '=';
            if (nodeType.includes('Inverter')) return '!';
            if (nodeType.includes('Retry')) return '↻';
            return '•';
        }

        // Update JSON editor
        function updateJSONEditor() {
            const editor = document.getElementById('json-editor');
            if (currentTree) {
                editor.value = JSON.stringify(currentTree, null, 2);
            } else {
                editor.value = '';
            }
        }

        // Update Python code
        function updatePythonCode() {
            const codeElement = document.getElementById('python-code');

            if (!currentTree) {
                codeElement.textContent = '# Load a tree to see Python code';
                return;
            }

            const code = generatePyTreesCode(currentTree);
            codeElement.innerHTML = syntaxHighlight(code);
        }

        // Generate py_trees Python code
        function generatePyTreesCode(tree) {
            let code = '';

            // Imports
            code += 'import py_trees\n';
            code += 'import operator\n';
            code += 'from py_trees.common import ComparisonExpression\n';
            code += 'from py_forest.sdk import PyForest\n';
            code += '\n';

            // Header comment
            code += `# ${tree.metadata.name} v${tree.metadata.version}\n`;
            if (tree.metadata.description) {
                code += `# ${tree.metadata.description}\n`;
            }
            code += '\n';

            // Generate tree
            code += '# Build the behavior tree\n';
            const rootVarName = generateNodeCode(tree.root, code, 0);

            code += '\n';
            code += '# Convert to PyForest format\n';
            code += 'pf = PyForest()\n';
            code += `tree = pf.from_py_trees(\n`;
            code += `    ${rootVarName},\n`;
            code += `    name="${tree.metadata.name}",\n`;
            code += `    version="${tree.metadata.version}"\n`;
            code += ')\n';
            code += '\n';
            code += '# Save to file\n';
            code += 'pf.save_tree(tree, "my_tree.json")\n';

            return code;
        }

        // Generate code for a node
        function generateNodeCode(node, parentCode, indent) {
            const ind = '    '.repeat(indent);
            const varName = sanitizeVarName(node.name);
            let code = '';

            // Generate node creation
            switch (node.node_type) {
                case 'Sequence':
                    code += `${ind}${varName} = py_trees.composites.Sequence(\n`;
                    code += `${ind}    "${node.name}",\n`;
                    code += `${ind}    memory=${node.config.memory || false}\n`;
                    code += `${ind})\n`;
                    break;

                case 'Selector':
                    code += `${ind}${varName} = py_trees.composites.Selector(\n`;
                    code += `${ind}    "${node.name}",\n`;
                    code += `${ind}    memory=${node.config.memory || false}\n`;
                    code += `${ind})\n`;
                    break;

                case 'Parallel':
                    code += `${ind}${varName} = py_trees.composites.Parallel(\n`;
                    code += `${ind}    "${node.name}",\n`;
                    code += `${ind}    policy=py_trees.common.ParallelPolicy.SuccessOnAll\n`;
                    code += `${ind})\n`;
                    break;

                case 'CheckBlackboardVariableValue':
                    const varNameCheck = node.config.variable_name || 'variable';
                    const op = node.config.operator || '<';
                    const value = node.config.expected_value || 0;
                    const opName = getOperatorName(op);

                    code += `${ind}check_${varNameCheck} = ComparisonExpression(\n`;
                    code += `${ind}    '${varNameCheck}',\n`;
                    code += `${ind}    operator.${opName},\n`;
                    code += `${ind}    ${JSON.stringify(value)}\n`;
                    code += `${ind})\n`;
                    code += `${ind}${varName} = py_trees.behaviours.CheckBlackboardVariableValue(\n`;
                    code += `${ind}    name="${node.name}",\n`;
                    code += `${ind}    check=check_${varNameCheck}\n`;
                    code += `${ind})\n`;
                    break;

                case 'SetBlackboardVariable':
                    const setVar = node.config.variable_name || 'variable';
                    const setValue = node.config.variable_value || '';
                    code += `${ind}${varName} = py_trees.behaviours.SetBlackboardVariable(\n`;
                    code += `${ind}    name="${node.name}",\n`;
                    code += `${ind}    variable_name="${setVar}",\n`;
                    code += `${ind}    variable_value=${JSON.stringify(setValue)},\n`;
                    code += `${ind}    overwrite=True\n`;
                    code += `${ind})\n`;
                    break;

                case 'Success':
                    code += `${ind}${varName} = py_trees.behaviours.Success("${node.name}")\n`;
                    break;

                case 'Failure':
                    code += `${ind}${varName} = py_trees.behaviours.Failure("${node.name}")\n`;
                    break;

                case 'Running':
                    code += `${ind}${varName} = py_trees.behaviours.Running("${node.name}")\n`;
                    break;

                case 'Inverter':
                    code += `${ind}# Decorator: Inverter\n`;
                    const childVar = node.children && node.children.length > 0
                        ? generateNodeCode(node.children[0], code, indent)
                        : 'child_node';
                    code += `${ind}${varName} = py_trees.decorators.Inverter(\n`;
                    code += `${ind}    "${node.name}",\n`;
                    code += `${ind}    child=${childVar}\n`;
                    code += `${ind})\n`;
                    return varName; // Don't process children again

                default:
                    code += `${ind}${varName} = py_trees.behaviours.Success("${node.name}")  # ${node.node_type}\n`;
            }

            // Add children
            if (node.children && node.children.length > 0 && !['Inverter', 'Retry', 'Repeat'].includes(node.node_type)) {
                code += '\n';
                for (const child of node.children) {
                    const childVar = generateNodeCode(child, code, indent);
                    code += `${ind}${varName}.add_child(${childVar})\n`;
                }
            }

            return varName;
        }

        // Get operator name
        function getOperatorName(op) {
            const ops = {
                '<': 'lt',
                '<=': 'le',
                '>': 'gt',
                '>=': 'ge',
                '==': 'eq',
                '!=': 'ne'
            };
            return ops[op] || 'eq';
        }

        // Sanitize variable name
        function sanitizeVarName(name) {
            return name
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '_')
                .replace(/^_+|_+$/g, '')
                .replace(/^(\d)/, '_$1') || 'node';
        }

        // Apply JSON changes
        function applyJSONChanges() {
            const editor = document.getElementById('json-editor');
            try {
                const newTree = JSON.parse(editor.value);

                // Validate
                if (!newTree.root || !newTree.metadata) {
                    throw new Error('Invalid tree structure: missing root or metadata');
                }

                currentTree = newTree;
                updateVisualTree();
                updatePythonCode();

                showNotification('Changes applied successfully!', 'success');
            } catch (error) {
                showNotification('JSON Error: ' + error.message, 'error');
            }
        }

        // Format JSON
        function formatJSON() {
            try {
                const editor = document.getElementById('json-editor');
                const parsed = JSON.parse(editor.value);
                editor.value = JSON.stringify(parsed, null, 2);
                showNotification('JSON formatted', 'success');
            } catch (error) {
                showNotification('Cannot format invalid JSON', 'error');
            }
        }

        // Download JSON
        function downloadJSON() {
            if (!currentTree) {
                showNotification('No tree loaded', 'error');
                return;
            }

            const json = JSON.stringify(currentTree, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentTree.metadata.name.replace(/\s+/g, '_')}_edited.json`;
            a.click();

            URL.revokeObjectURL(url);
            showNotification('JSON downloaded', 'success');
        }

        // Copy Python code
        function copyPythonCode() {
            const codeElement = document.getElementById('python-code');
            const code = codeElement.textContent;

            navigator.clipboard.writeText(code).then(() => {
                showNotification('Python code copied to clipboard!', 'success');
            });
        }

        // Syntax highlighting
        function syntaxHighlight(code) {
            return code
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/(import|from|def|class|return|if|else|for|while|try|except|with|as)\b/g, '<span class="keyword">$1</span>')
                .replace(/(['"])(.*?)\1/g, '<span class="string">$1$2$1</span>')
                .replace(/(#.*$)/gm, '<span class="comment">$1</span>')
                .replace(/\b(\d+)\b/g, '<span class="number">$1</span>');
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Show empty state
        function showEmptyState() {
            const treeView = document.getElementById('tree-view');
            treeView.innerHTML = `
                <div class="empty-state">
                    <h3>No Tree Loaded</h3>
                    <p>Click "Load JSON File" to get started</p>
                    <p style="font-size: 12px; color: #666;">
                        Try loading: examples/robot_v1.json or examples/robot_v2.json
                    </p>
                </div>
            `;

            document.getElementById('json-editor').value = '';
            document.getElementById('python-code').textContent = '# Load a tree to see Python code';
        }
    </script>
</body>
</html>
